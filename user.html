<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>我的</title>
    <link href="https://cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <link href="bootstrap/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="bootstrap/css/user.css">
    <script src="js/jquery.js"></script>
    <script src="bootstrap/js/bootstrap.js"></script>
    <script src="js/vue.js"></script>
    <!-- 异步提交的库 -->
    <script src="js/vue-resource.js"></script>

    <script>
        $(function(){
            get_token();
            show_courses();
        });
        function get_token(){
            var token = localStorage.getItem("token");
        }

        function create_course_div(course){
            console.log(course);
            course_id = course.course_id;
            html = "";
            temp = "<div>";
            html+=temp;
            html += "课程名："+course.title+"<br>";
            var button = "<button onclick=\"goToClass(\'course_id\')\">"+"开始上课"+"</button>";
            button=button.replace(/course_id/,course_id);
            html += button;
            html += "<br><br>";
            html += "</div>";
            return html;
        }

        function show_courses(){
            // console.log(Date.parse(new Date()));
            // console.log(localStorage.getItem("public_courses_dict"));
            var courses = localStorage.getItem("my_courses_list");
            var keyword = localStorage.getItem("my_courses_keyword");
            if (keyword){
                $("#text").attr("placeholder",keyword);
            }
            if (courses){
                //pass
            }else if (keyword){
                search_my();
                courses = localStorage.getItem("my_courses_list");
            }else{
                keyword="";
                localStorage.setItem("my_courses_keyword",keyword);
                search_my();
                courses = localStorage.getItem("my_courses_list");    
            }
            courses = JSON.parse(courses);
            var ulObj = document.createElement("ul");
            for (var i=0, n=courses.length;i<n;i++){
                course = courses[i];
                var liObj = document.createElement("li");
                tempHTML = create_course_div(course);
                liObj.innerHTML = tempHTML;
                ulObj.appendChild(liObj);
            }
            
            $("#course_list").append(ulObj);
        }
    </script>
<!--修改placeholder颜色，不同浏览器不同-->
    <style>
        input::-webkit-input-placeholder{
            color:whitesmoke;
        }
        input::-moz-placeholder{   /* Mozilla Firefox 19+ */
            color:whitesmoke;
        }
        input:-moz-placeholder{    /* Mozilla Firefox 4 to 18 */
            color:whitesmoke;
        }
        input:-ms-input-placeholder{  /* Internet Explorer 10-11 */
            color:whitesmoke;
        }
    </style>
</head>
<body>
<ul class="nav">
    <a href="index.html"><img src="images/logo1.png" class="logo" /></a>
        
    <ul class="one">
        <li>
            <a href="#">课程分类</a>
            <ul class="nav2">
                <li><a href="#">产品1</a></li>
                <li><a href="#">产品2</a></li>
                <li><a href="#">产品3</a></li>
            </ul>
        </li>
    </ul> 
    <form id ="sea" class="sea" >   
        <input class="search" type="text" name="keyword" placeholder="搜索我的课程" id="text" style="background-color: grey;border-radius: 15px" />
        <img type="image" src="images/search.png" id="search" onclick="search_my()" />
    </form>

    <ul class="other">
        <li>
            <a href="my_course.html">我的学习</a>
            <ul class="nav2">
                <li><a href="#">产品1</a></li>
                <li><a href="#">产品2</a></li>
                <li><a href="#">产品3</a></li>
            </ul>
        </li>
        <li><a href="publish_course.html">发布任务</a></li>
        <li> <a href="message.html"><img src="images/message.png" class="messages" onclick="" > </a></li>
        <li><img src="images/cart.png" class="cart" onclick="" > </li>
    </ul>
</ul>
<div class="setin" >
    <li><a href="info.html"><img src="images/portrait.png" class="portrait" onclick="" > </a></li>
    <button class="btn" type = "button" id = "my_info" onclick = "goToInfo()">个人资料</button>
    <button  class="btn" type = "button" id = "set" onclick = "goToInfo()">设置</button>
</div>

<div id = "course_list" >我的课程：</div>


</body>
<script>
    function goToInfo(){
        window.location.href = "info.html";

    }

    function goToClass(course_id){
        var account = localStorage.getItem('account');
        var token = localStorage.getItem('token');
        $.ajax(
            {
                url:'proxy/get_room_url.php',
                async: false,
                type: 'POST',
                dataType: 'json',
                data:{account:account,token:token,course_id:course_id},
                success : function(obj,textstatus){
                    console.log(obj);
                    code = obj.code;
                    if (code == 200) {
                        url = obj.data;
                        window.open(url, "_blank", "scrollbars=yes,resizable=1,modal=false,alwaysRaised=yes");
                    }else{
                        alert(obj.data);
                    }
                },
                error : function(xhr){
                    console.log(xhr.responseText);
                }
            }
        )
    }

    function search_my(){
        var param = new FormData(document.getElementById("sea"));
        var keyword = param.get('keyword');
        var account = localStorage.getItem('account');
        console.log(keyword);
        $.ajax(
            {
                url:'proxy/search_my_courses.php',
                async: false,
                type: 'POST',
                dataType: 'json',
                data:{account:account,field:keyword},
                success : function(obj,textstatus){
                    console.log(obj);
                    localStorage.setItem("my_courses_keyword",keyword);
                    var data = obj.data;
                    var temp_list =[];
                    for (var i=0, n = data.length; i< n ;i++){
                        console.log(data[i]);
                        course_id = data[i].course_id;
                        info = JSON.parse(data[i].info);
                        info["course_id"]=course_id;
                        temp_list.push(info);
                    }
                    localStorage.setItem("my_courses_list",JSON.stringify(temp_list));
                    document.location.reload(true);
                },
                error : function(xhr){
                    console.log(xhr.responseText);
                }
                
            }
        )

    }

</script>

</html>
