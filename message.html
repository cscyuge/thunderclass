<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>信息</title>
    <link href="https://cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <link href="bootstrap/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="bootstrap/css/message.css">
    <script src="js/jquery.js"></script>
    <script src="bootstrap/js/bootstrap.js"></script>
    <script src="js/vue.js"></script>
    <!-- 异步提交的库 -->
    <script src="js/vue-resource.js"></script>

    <script>

        $(function(){
            getId();
           // showSection(id);
            get_token();
            show_courses();
        });
        /*把相应section的id和用户点击的导航栏href值比较，改变各个section的display属性*/
        function showSection(id) {
            var sections = document.getElementsByTagName("section");
            for(var i=0;i<sections.length;i++) {
                if(sections[i].getAttribute("id") != id) {
                    sections[i].style.display = "none";
                }else {
                    sections[i].style.display = "block";
                }
            }
        }
        /*把导航栏href和用户点击href比较，改变相应元素的父元素的className*/
        function changeColor(id) {
            var navs = document.getElementsByTagName("nav");
            var links = navs[0].getElementsByTagName("a");
            for (var i = 0; i <links.length; i++) {
                var sectionId = links[i].getAttribute("href").split("#")[1];
                if(sectionId == id){
                    links[i].parentNode.className = "special";
                }else {
                    links[i].parentNode.className = "";
                }
            }
        }
        function getId() {
            var navs = document.getElementsByTagName("nav");
            var links = navs[0].getElementsByTagName("a");
            for (var i = 0; i <links.length; i++) {
                //获取导航栏的href值
                var secId = links[i].getAttribute("href").split("#")[1];
                if (!document.getElementById(secId)) continue;
                //设置最初的演示
                document.getElementById(secId).style.display = "none";
                document.getElementById("album").style.display = "block";
                /*这里存在作用域问题，secId是个局部变量，它在getId函数执行期间存在，
                到时间处理函数执行的时候就不存在了，故在这里为每个链接创建了一个自定义的属性destination*/
                links[i].destination = secId;
                links[i].onclick = function() {
                    showSection(this.destination);
                    changeColor(this.destination);
                    return false;
                }
            };
        }


        function create_course_div(course){
            html = "";
            temp = "<div id = course_id>";
            temp = temp.replace(/course_id/,course._t);
            html+=temp;
            if (course.sender == "system"){
                html+="系统发布<br>";
                html+="消息:"+course.msg+"<br>";
            }else{
                html+="学生发布<br>";
                html+="学生:"+course.msg+"<br>";
            }
            html += "发送者："+course.sender+"<br>";
            var begin = new Date(course._t);
            html += "发送时间："+ (begin.toLocaleDateString().replace(/\//g, "-") + " " + begin.toTimeString().substr(0, 8)) + "<br>";
           // var button = "<button onclick=\"check(\'course_id\')\">"+"check"+"</button>";
            //button=button.replace(/course_id/,course.course_id);
           // html += button;
            html += "<br><br>";
            html += "</div>";
            return html;
        }

       function show_courses(){
            //console.log(Date.parse(new Date()));
            //console.log(localStorage.getItem("public_courses_dict"));
            var courses = localStorage.getItem("msg_dict");
           console.log("第1次");
           console.log(courses);
            courses = JSON.parse(courses);//解析对象之前要JSON.parse
           console.log("第2次");
           console.log(courses);
           console.log(courses.length);
            var ulObj = document.createElement("ul");
                for (var i=0, n=courses.length;i<n;i++){
                    course = courses[i];
                    console.log(course);
                    var liObj = document.createElement("li");
                    tempHTML = create_course_div(course);
                    liObj.innerHTML = tempHTML;
                    ulObj.appendChild(liObj);
                }
            $("#course_list").append(ulObj);
        }

      function get_token(){
            var token = localStorage.getItem("token");
            var account = localStorage.getItem("account");
            var timestamp=new Date().getTime();
            if (token){
                $.ajax(
                    {
                        url: 'proxy/get_msg.php',
                        type: 'POST',
                        dataType: 'json',
                        data: {account: account,communicator:"system", token: token},
                        success: function (obj, textstatus) {
                            console.log(token);
                            console.log(account);
                            // alert(token);
                             //alert(account);
                            console.log(obj);
                            if (obj.code == 200) {
                                console.log("1");
                                obj = obj.data;
                                console.log("2");
                                 msg=obj[0].msg;
                                console.log("3");
                                obj = $.parseJSON(obj[0]);
                                console.log("4");
                                localStorage.setItem("msg_dict",JSON.stringify(obj));
                                console.log("5");
                                document.location.reload(true);
                                console.log("6");
                                $('#msg').attr("value", msg);
                                console.log("7");
                            } else {
                                alert("获取消息错误");
                            }

                        },
                        error: function (xhr) {
                            // console.log(xhr.responseText);
                            alert("服务器错误");
                        }

                    }
                )
            }else{
                alert("用户认证过期，请重新登录");
                localStorage.clear();
                window.location.href = 'index.html';
            }
            console.log("helloaaa");
        }
    </script>
</head>
<body>
<ul class="nav">
    <a href="index.html"><img src="images/logo1.png" class="logo" /></a>

    <ul class="one">
        <li>
            <a href="#">课程分类</a>
            <ul class="nav2">
                <li><a href="#">产品1</a></li>
                <li><a href="#">产品2</a></li>
                <li><a href="#">产品3</a></li>
            </ul>
        </li>
    </ul>
    <form id ="sea" class="sea" >
        <input class="search" type="text" name="keyword" placeholder="搜索我的课程" id="text" />
        <img type="image" src="images/search.png" id="search" onclick="search_my()" />
    </form>

    <ul class="other">
        <li>
            <a href="#">我的学习</a>
            <ul class="nav2">
                <li><a href="#">产品1</a></li>
                <li><a href="#">产品2</a></li>
                <li><a href="#">产品3</a></li>
            </ul>
        </li>
        <li><img src="images/message.png" class="messages" onclick="" > </li>
        <li><img src="images/cart.png" class="cart" onclick="" > </li>
    </ul>
</ul>
<div class="d_msg">
<ul class="msg" >
    <nav>
        <ul>
            <li class="special"><a href="#album">● 系统消息</a></li>
            <li><a href="#dynamic">● 课程消息</a></li>
            <li><a href="#relationship">● 我的消息</a></li>
           <!-- <li><a href="#collection">我的收藏</a></li>-->
        </ul>
    </nav>
   <!-- <p><span style="display:inline-block;width:100px;text-align:right;">消息</span>
        <input type="text" name="msg" id="msg" value="" required/>*</p>  -->
</ul>
</div>
<section class="sys_msg" id="album">
    <p><span style="font-weight: bold">系统通知：</span> 2020年5月11日 13：00</p>
    <p>您已成功开通会员，截止日期至2020年6月11日，感谢您的支持</p>
</section>
<section  class="courses_msg" id="dynamic">
    <div class="course_msg">
    <p><span style="font-weight: bold">上课提醒：</span> 2020年5月11日 12：00</p>
    <p>您的课程《小学六年级语文》将在下午6：00开始上课</p>
    </div>
    <div  class="course_msg">
        <p><span style="font-weight: bold">上课提醒：</span> 2020年5月11日 12：00</p>
        <p>您的课程《小学六年级语文》发布了一个作业，截至提交时间为2020年5月14日12：00</p>
    </div>
</section>

<section id="relationship">
    <div class="friend">
        <a href="info.html"><img src="images/portrait.png" class="portrait" onclick="" > 灰灰灰 </a>
    </div>
    <div class="chat_area">

    </div>
    <div class="chat">
        <form id ="dialog">
            <textarea style="width:586px;height:100px;"  id= 'condition' name= "condition" placeholder="回复一下吧~" ></textarea>
            <button class="btnn" onclick="" type="button">发送</button>
        </form>
    </div>
</section>

<div id = "course_list" >搜索结果：</div>
<input type="text" name="username" id="msg" value="" required/>
</body>
</html>