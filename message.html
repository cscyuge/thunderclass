<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>信息</title>
    <link href="https://cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <link href="bootstrap/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="bootstrap/css/message.css">
    <script src="js/jquery.js"></script>
    <script src="bootstrap/js/bootstrap.js"></script>
    <script src="js/vue.js"></script>
    <!-- 异步提交的库 -->
    <script src="js/vue-resource.js"></script>

    <script>

        $(function(){
            get_token();
            show_courses();
        });

        function create_course_div(course){
            html = "";
            temp = "<div id = course_id>";
            temp = temp.replace(/course_id/,course._t);
            html+=temp;
            if (course.sender == "system"){
                html+="系统发布<br>";
                html+="消息:"+course.msg+"<br>";
            }else{
                html+="学生发布<br>";
                html+="学生:"+course.msg+"<br>";
            }
            html += "发送者："+course.sender+"<br>";
            var begin = new Date(course._t);
            html += "发送时间："+ (begin.toLocaleDateString().replace(/\//g, "-") + " " + begin.toTimeString().substr(0, 8)) + "<br>";
           // var button = "<button onclick=\"check(\'course_id\')\">"+"check"+"</button>";
            //button=button.replace(/course_id/,course.course_id);
           // html += button;
            html += "<br><br>";
            html += "</div>";
            return html;
        }

        function show_courses(){
            // console.log(Date.parse(new Date()));
            // console.log(localStorage.getItem("public_courses_dict"));
            var courses = localStorage.getItem("msg_dict");
            courses = JSON.parse(courses);//解析对象之前要JSON.parse
            var ulObj = document.createElement("ul");
                for (var i=0, n=courses.length;i<n;i++){
                    course = courses[i];
                    console.log(course);
                    var liObj = document.createElement("li");
                    tempHTML = create_course_div(course);
                    liObj.innerHTML = tempHTML;
                    ulObj.appendChild(liObj);
                }
            }
            $("#course_list").append(ulObj);
        }

        function get_token(){
            var token = localStorage.getItem("token");
            var account = localStorage.getItem("account");
            var timestamp=new Date().getTime();
            if (token){
                $.ajax(
                    {
                        url: 'proxy/get_msg.php',
                        type: 'POST',
                        dataType: 'json',
                        data: {account: account,since:timestamp ,communicator:"system", token: token},
                        success: function (obj, textstatus) {
                            // alert(token);
                            // alert(account);
                            console.log(obj);
                            if (obj.code == 200) {
                                obj = obj.data;
                                msg=obj[0].msg;
                                obj = $.parseJSON(obj);
                                localStorage.setItem("msg_dict",JSON.stringify(obj.data));
                                document.location.reload(true);

                                $('#msg').attr("value", msg);

                            } else {
                                alert("获取消息错误");
                            }

                        },
                        error: function (xhr) {
                            // console.log(xhr.responseText);
                            alert("服务器错误");
                        }

                    }
                )
            }else{
                alert("用户认证过期，请重新登录");
                localStorage.clear();
                window.location.href = 'index.html';
            }
        }
    </script>
</head>
<body>
<ul class="nav">
    <a href="index.html"><img src="images/logo1.png" class="logo" /></a>

    <ul class="one">
        <li>
            <a href="#">课程分类</a>
            <ul class="nav2">
                <li><a href="#">产品1</a></li>
                <li><a href="#">产品2</a></li>
                <li><a href="#">产品3</a></li>
            </ul>
        </li>
    </ul>
    <form id ="sea" class="sea" >
        <input class="search" type="text" name="keyword" placeholder="搜索我的课程" id="text" />
        <img type="image" src="images/search.png" id="search" onclick="search_my()" />
    </form>

    <ul class="other">
        <li>
            <a href="#">我的学习</a>
            <ul class="nav2">
                <li><a href="#">产品1</a></li>
                <li><a href="#">产品2</a></li>
                <li><a href="#">产品3</a></li>
            </ul>
        </li>
        <li><img src="images/message.png" class="messages" onclick="" > </li>
        <li><img src="images/cart.png" class="cart" onclick="" > </li>
    </ul>
</ul>
<div class="d_msg">
<ul class="msg" >
    <li><a href="#" onclick = "">● 系统消息</a></li>
    <li><a href="#" onclick = "">● 课程消息</a></li>
    <li><a href="#" onclick = "">● 我的消息</a></li>
</ul>
    <p><span style="display:inline-block;width:100px;text-align:right;">消息</span>
        <input type="text" name="msg" id="msg" value="" required/>*</p>
</div>
</body>
</html>